<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssafy.metassafy.mapper.chatting.ChatMapper">

<!--	private int croom_no;-->
<!--	private String croom_name;-->
<!--	private String last_chat;-->
<!--	private int not_read_chat;-->
<!--	private String regtime;-->


	<select id="findAllRooms" parameterType="com.ssafy.metassafy.dto.chatting.ChatParameterDto" resultType="com.ssafy.metassafy.dto.chatting.ChatRoomDto">
		SELECT c.croom_no, c.croom_name, c.last_chat, (select not_read_chat from participant where user_id = #{user_id} and croom_no = c.croom_no) not_read_chat, c.regtime
		FROM chatroom c
		WHERE c.croom_no in (SELECT croom_no FROM participant WHERE user_id = #{user_id})
	</select>

	<insert id="createChatRoom" parameterType="string">
		INSERT INTO chatroom (croom_name)
		VALUES (#{croom_name})
	</insert>

	<update id="editChatRoom" parameterType="com.ssafy.metassafy.dto.chatting.ChatParameterDto">
		UPDATE chatroom
		SET croom_name = #{croom_name}
		WHERE croom_no = #{croom_no}
	</update>

	<delete id="deleteChatRoom" parameterType="com.ssafy.metassafy.dto.chatting.ChatParameterDto">
		DELETE FROM chatroom
		WHERE croom_no = #{croom_no}
	</delete>

<!--	private int chat_no;-->
<!--	private int croom_no;-->
<!--	private String user_id;-->
<!--	private String user_name;-->
<!--	private String message;-->
<!--	private int not_read;-->
<!--	private String regtime;-->

	<select id="findAllChat" parameterType="com.ssafy.metassafy.dto.chatting.ChatParameterDto" resultType="com.ssafy.metassafy.dto.chatting.ChatDto">
		SELECT c.chat_no, c.croom_no, c.user_id, u.name, c.message, c.not_read, c.regtime
		FROM chat c
		LEFT JOIN user u
		ON c.user_id = u.user_id
		WHERE c.croom_no = #{croom_no}
	</select>

	<select id="getMemberNum" parameterType="com.ssafy.metassafy.dto.chatting.ChatDto" resultType="int">
		SELECT COUNT(*)
		FROM participant
		WHERE croom_no = #{croom_no}
	</select>

	<select id="getLastReadChatId" parameterType="Integer" resultType="int">
		SELECT max(chat_no)
		FROM chat
		WHERE croom_no = #{croom_no}
	</select>

	<insert id="createChat" parameterType="com.ssafy.metassafy.dto.chatting.ChatDto">
		INSERT INTO chat (croom_no, user_id, message, not_read)
		VALUES (#{croom_no}, #{user_id}, #{message}, #{not_read})
	</insert>

	<select id="getChatNo" parameterType="com.ssafy.metassafy.dto.chatting.ChatDto" resultType="int">
		SELECT chat_no
		FROM chat
		WHERE croom_no = #{croom_no} and user_id = #{user_id}
		ORDER BY chat_no DESC LIMIT 1
	</select>

	<update id="updateLastChat" parameterType="com.ssafy.metassafy.dto.chatting.ChatDto">
		UPDATE chatroom
		SET last_chat = #{message}
		WHERE croom_no = #{croom_no}
	</update>

	<update id="updateNotRead" parameterType="com.ssafy.metassafy.dto.chatting.ChatParameterDto">
		UPDATE chat
		SET not_read = (SELECT count(*) FROM participant WHERE croom_no = #{croom_no} AND last_read_chat_id &lt; #{chat_no})
		WHERE chat_no = #{chat_no}
	</update>



<!--	private String user_id;-->
<!--	private int croom_no;-->
<!--	private String croom_name;-->
<!--	private int not_read_chat;-->
<!--	private int last_read_chat_id;-->
<!--	private String regtime;-->

	<!-- 모든 participant 리스트 -->
	<select id="findAllParticipants" parameterType="com.ssafy.metassafy.dto.chatting.ChatParameterDto" resultType="com.ssafy.metassafy.dto.chatting.ParticipantDto">
		SELECT p.user_id, p.croom_no, p.croom_name, p.not_read_chat, p.last_read_chat_id, p.regtime
		FROM participant p
				 LEFT JOIN chatroom c
						   ON p.croom_no = c.croom_no
		WHERE p.user_id = #{user_id}
	</select>

	<!-- 친구 추가시 participant 등록  -->
	<insert id="registParticipant" parameterType="com.ssafy.metassafy.dto.chatting.ChatDto">
		INSERT INTO participant (user_id, croom_no, croom_name, not_read_chat, last_read_chat_id)
		VALUES (#{user_id}, #{croom_no}, #{croom_name}, 0, #{last_read_chat_id})
	</insert>

	<delete id="deleteParticipant" parameterType="com.ssafy.metassafy.dto.chatting.ChatDto">
		DELETE FROM participant
		WHERE user_id = #{user_id} AND croom_no = #{croom_no}
	</delete>

	<!-- not_read_chat 갱신 -->
	<update id="renewNotReadChat" parameterType="java.util.List">
		<foreach collection="list" item="item" index="index" open="" close="" separator=";">
			UPDATE participant
			SET not_read_chat = (SELECT count(*) FROM chat WHERE croom_no = #{item.croom_no} AND chat_no > #{item.last_read_chat_id})
			WHERE user_id = #{item.user_id} AND croom_no = #{item.croom_no}
		</foreach>
	</update>

	<!-- last_read_chat_id 갱신 -->
	<update id="renewLastReadChatId" parameterType="com.ssafy.metassafy.dto.chatting.ParticipantDto">
		UPDATE participant
		SET last_read_chat_id = (SELECT chat_no FROM chat WHERE croom_no = #{croom_no} ORDER BY chat_no DESC LIMIT 1)
		WHERE user_id = #{user_id} AND croom_no = #{croom_no}
	</update>

</mapper>

